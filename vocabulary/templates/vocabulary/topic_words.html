{% extends 'vocabulary/base.html' %}

{% block content %}

<style>
    .topic-container { padding-top: 90px; padding-bottom: 3rem; }
    .japan-word { font-size: 1.5rem; }

    @media (max-width: 576px) {
        .topic-container { padding-top: 20px !important; }
        .japan-word { font-size: 1.2rem !important; }
        .sakura-card { padding: 15px !important; }
        h2 { font-size: 1.5rem !important; }
    }
</style>

<div class="container topic-container">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'categories' %}" class="text-decoration-none text-muted mb-2 d-inline-block">
                <i class="bi bi-arrow-left"></i> Orqaga
            </a>
            <h2 class="fw-bold text-dark m-0">{{ topic_name }}</h2>
            <p class="text-muted small m-0">Mavzuga oid so'zlar</p>
        </div>

        <button id="save-all-btn" class="btn btn-outline-primary rounded-pill d-flex align-items-center shadow-sm" data-topic-name="{{ topic_name }}">
            <i class="bi bi-bookmark-heart fs-5"></i>
            <span class="ms-2 d-none d-sm-inline">Hammasini saqlash</span>
        </button>
    </div>

    <div class="row g-3">
        {% for word in words %}
        <div class="col-12">
            <div class="sakura-card p-3 bg-white shadow-sm rounded-4 border-0 position-relative">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-1">
                        <h5 class="fw-bold text-primary mb-0 me-2 japan-word">{{ word.japanese_word }}</h5>
                        <i class="bi bi-volume-up-fill text-secondary" style="cursor: pointer; font-size: 1.2rem;" onclick="speak('{{ word.japanese_word|escapejs }}')"></i>
                    </div>

                    {% if word.hiragana %}
                    <p class="text-muted small mb-1 fst-italic">({{ word.hiragana }})</p>
                    {% endif %}

                    <p class="mb-3 text-dark small"><strong>Ma'nosi:</strong> {{ word.meaning }}</p>

                    <div class="border-top pt-2 d-flex justify-content-between align-items-center">
                        <button class="btn p-0 text-decoration-none d-flex align-items-center save-btn" data-word-id="{{ word.id }}" style="border: none; background: none;">
                            <i class="bi {% if request.user in word.saves.all %}bi-heart-fill text-danger{% else %}bi-heart text-secondary{% endif %} fs-5 me-2 heart-icon-{{ word.id }}"></i>
                            <span class="small text-muted save-text-{{ word.id }}">{% if request.user in word.saves.all %}Saqlangan{% else %}Saqlash{% endif %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-5">
            <p class="text-muted">Bu mavzuda hali so'zlar yo'q.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // 1. YAKKA SO'ZLARNI SAQLASH
    document.querySelectorAll('.save-btn').forEach(button => {
        button.addEventListener('click', function() {
            const wordId = this.getAttribute('data-word-id');
            const icon = document.querySelector(`.heart-icon-${wordId}`);
            const text = document.querySelector(`.save-text-${wordId}`);
            
            fetch(`/toggle_save/${wordId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.saved) {
                        icon.classList.remove('bi-heart', 'text-secondary');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                        text.textContent = "Saqlangan";
                    } else {
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                        icon.classList.add('bi-heart', 'text-secondary');
                        text.textContent = "Saqlash";
                    }
                });
        });
    });

    // 2. HAMMASINI SAQLASH
    const saveAllBtn = document.getElementById('save-all-btn');
    if (saveAllBtn) {
        saveAllBtn.addEventListener('click', function() {
            // BU YERDA HAM O'ZGARISH: topic_name ni olamiz
            const topicName = this.getAttribute('data-topic-name'); 
            const iconMain = this.querySelector('i');
            const spanMain = this.querySelector('span');
            
            iconMain.className = 'bi bi-hourglass-split';

            // URL ga e'tibor bering!
            fetch(`/save_all_topic/${topicName}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.saved) {
                        iconMain.className = 'bi bi-bookmark-check-fill';
                        this.classList.replace('btn-outline-primary', 'btn-primary');
                        spanMain.textContent = "Saqlashdan olish";
                        
                        document.querySelectorAll('.save-btn i').forEach(icon => {
                            icon.classList.remove('bi-heart', 'text-secondary');
                            icon.classList.add('bi-heart-fill', 'text-danger');
                        });
                        document.querySelectorAll('.save-btn span').forEach(span => {
                            span.textContent = "Saqlangan";
                        });

                    } else {
                        iconMain.className = 'bi bi-bookmark-heart';
                        this.classList.replace('btn-primary', 'btn-outline-primary');
                        spanMain.textContent = "Hammasini saqlash";

                        document.querySelectorAll('.save-btn i').forEach(icon => {
                            icon.classList.remove('bi-heart-fill', 'text-danger');
                            icon.classList.add('bi-heart', 'text-secondary');
                        });
                        document.querySelectorAll('.save-btn span').forEach(span => {
                            span.textContent = "Saqlash";
                        });
                    }
                })
                .catch(err => {
                    console.error("Xatolik:", err);
                    iconMain.className = 'bi bi-exclamation-triangle';
                });
        });
    }
</script>

{% endblock %}